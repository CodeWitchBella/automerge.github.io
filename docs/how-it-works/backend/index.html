<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.9">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Automerge CRDT RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Automerge CRDT Atom Feed"><title data-react-helmet="true">How Automerge works | Automerge CRDT</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://automerge.github.io//docs/how-it-works/backend"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="How Automerge works | Automerge CRDT"><meta data-react-helmet="true" name="description" content="This document explains how Automerge stores data internally. You shouldn&#x27;t need"><meta data-react-helmet="true" property="og:description" content="This document explains how Automerge stores data internally. You shouldn&#x27;t need"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://automerge.github.io//docs/how-it-works/backend"><link data-react-helmet="true" rel="alternate" href="https://automerge.github.io//docs/how-it-works/backend" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://automerge.github.io//docs/how-it-works/backend" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.b00b1ad0.css">
<link rel="preload" href="/assets/js/runtime~main.61857cbb.js" as="script">
<link rel="preload" href="/assets/js/main.77a0dc06.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/automerge.png" alt="Automerge logo" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/img/automerge.png" alt="Automerge logo" class="themedImage_TMUO themedImage--dark_uzRr"></div><b class="navbar__title">Automerge</b></a><a class="navbar__item navbar__link navbar__link--active" href="/docs/hello">Docs</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/automerge" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">ðŸŒœ</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">ðŸŒž</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_lDyR"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_i9tI" type="button"></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/hello">Welcome to Automerge</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/quickstart">5-Minute Quick Start</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Tutorial</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Types</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Cookbook</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Internals</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/how-it-works/backend">How Automerge works</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/how-it-works/binary-format">Binary Document Format</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/how-it-works/sync">Sync Protocol</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/api">API</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/glossary">Glossary</a></li></ul></nav></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><div class="tocCollapsible_aw-L theme-doc-toc-mobile tocMobile_Tx6Y"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>How Automerge works</h1></header><p>This document explains how Automerge stores data internally. You shouldn&#x27;t need
to read it in order to use Automerge in your application, but you might find it
useful if you want to hack on the Automerge code itself.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="document-changes-and-operations">Document, changes, and operations<a aria-hidden="true" class="hash-link" href="#document-changes-and-operations" title="Direct link to heading">â€‹</a></h2><p>You get an Automerge instance by calling <code>Automerge.init()</code> (creates a new, empty
document) or <code>Automerge.load()</code> (loads an existing document, typically from
a file on disk). By default, this document exists only in memory on a single
device, and you don&#x27;t need any network communication for read or write access.
There may be a separate networking layer that asynchronously propagates changes
from one device to another, but that networking layer is outside of the scope of
Automerge itself.</p><p>The Automerge instance represents the current state of your application (or some part of it).
The state is immutable and is never updated in place. Instead, whenever you want
to do something that changes the state, you call a function that takes the old
state as first argument, and returns a new state reflecting the change. There
are two ways how the state can change:</p><ol><li><strong>Local changes</strong>, which are generally triggered by the user changing some
piece of application data in the user interface. Such editing by the user is
expressed by calling <code>Automerge.change()</code>, which groups together a block
of operations that should be applied as an atomic unit. Within the change
callback you have access to a mutable version of the Automerge document,
implemented as a
<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy" target="_blank" rel="noopener noreferrer">Proxy</a>).
The proxy records any mutations you make as <em>operations</em> (e.g. changing the
value of a particular property of a particular object). The <code>change()</code>
function returns a new copy of the state with those operations applied.</li><li><strong>Remote changes</strong>: a user on another device has edited their copy of
a document, that change was sent to you via the network, and now you want
to apply it to your own copy of the document. Remote operations are applied
using <code>Automerge.applyChanges()</code>, which again returns a new copy of the
state. For testing purposes there is also <code>Automerge.merge()</code>, which is
is a short-cut for the case where the &quot;remote&quot; document is actually just
another instance of Automerge in the same process.</li></ol><p>Some terminology:</p><ul><li>An <strong>operation</strong> is a fine-grained description of a single modification, e.g.
setting the value of a particular property of a particular object, or
inserting one element into a list. Users normally never see operations â€” they
are a low-level implementation detail.</li><li>A <strong>change</strong> is a collection of operations grouped into a unit that is
applied atomically (a bit like a database transaction). Each call to
<code>Automerge.change()</code> produces exactly one change, and inside the change there
may be any number of operations. A change is also the smallest unit that gets
transmitted over the network to other devices.</li><li>A <strong>document</strong> is the state of a single Automerge instance. The state of a
document is determined by the set of all changes that have been applied to
it. Automerge ensures that whenever any two documents have seen the same
set of changes, even if the changes were applied in a different order, then
those documents are in the same state. This means an Automerge document is a
<a href="https://crdt.tech/" target="_blank" rel="noopener noreferrer">CRDT</a>.</li></ul><p><code>Automerge.getChanges()</code> returns all the changes that have occurred between one
document state and another, so that they can be encoded and sent over the
network to other devices. On the recipient&#x27;s end, <code>Automerge.applyChanges()</code>
updates the corresponding document to incorporate those changes.</p><p>You can save a document to disk using <code>Automerge.save()</code>. This function really
just takes all the changes that have ever happened in the document, and encodes
them as a string. Conversely, <code>Automerge.load()</code> decodes that string and applies
all of the changes to a new, blank document. This works because we can always
reconstruct the document state from the set of changes. For this reason, a
document preserves its entire editing history, even across saves and reloads
(a bit like a Git repository).</p><p>One day, we may need to allow this history to be pruned in order to save disk
space. There are also privacy implications in storing the whole history: any
new collaborator who gets access to a document can see all past states of the
document, including any content that is now deleted. However, for now we are
choosing to preserve all history as it makes synchronisation easier (imagine
a device that has been offline for a long time, and then needs to catch up on
everything that has been changed by other users while it was offline).
Moreover, being able to inspect edit history is itself a useful feature.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="actor-ids-vector-clocks-and-causality">Actor IDs, vector clocks, and causality<a aria-hidden="true" class="hash-link" href="#actor-ids-vector-clocks-and-causality" title="Direct link to heading">â€‹</a></h2><p>Each Automerge instance has an <strong>actor ID</strong> â€” a UUID that is generated randomly
whenever you do <code>Automerge.init()</code> or <code>Automerge.load()</code> (unless you explicitly
pass an actor ID into those functions). Whenever you make a local edit on that
Automerge instance, the operations are tagged with that actor ID as the origin.
All changes made on a Automerge instance are numbered sequentially, starting
with 1 and never skipping or reusing sequence numbers. We assume that nobody
else is using the same actor ID, and thus each change is uniquely identified
by the combination of its originating actor ID and its sequence number. That
unique identifier for the change always remains fixed, even when it is
applied on remote copies of the document.</p><p>An actor ID is a bit similar to a device ID. Each device can generate changes
independently from every other device, and so each device needs to have its own
numbering sequence. You can have several actor IDs for the same device, for
example if the user might run several instances of the application on the same
device (in which case, each instance needs its own actor ID). However, there is
a performance cost to having lots of actor IDs, so it&#x27;s a good idea to keep
using the same actor ID if possible (at least for the lifetime of an application
process).</p><p>With those sequence numbers in place, we can fairly efficiently keep track of
all changes we&#x27;ve seen: for each actor ID, we apply the changes
originating on that instance in strictly incrementing order; and then we only
need to store the highest sequence number we&#x27;ve seen for each actor ID. This
mapping from actor ID to highest sequence number is called a <em>vector clock</em>.</p><p>The vector clock is useful when two peers are communicating, and need to
figure out which changes they need to send to each other in order to get in
sync. If the peers send each other their vector clocks, each peer can see the
highest sequence number for each actor that the other peer has seen; if it has
any changes with higher sequence numbers, it sends those. See <code>src/connection.js</code>
for an implementation of such a protocol.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="dependencies">Dependencies<a aria-hidden="true" class="hash-link" href="#dependencies" title="Direct link to heading">â€‹</a></h3><p>In our documents, one change sometimes depends on another. For example, if
an item is first added and then removed, it doesn&#x27;t make sense to try to apply
the removal if you haven&#x27;t already seen the addition (since you&#x27;d be trying to
remove something that doesn&#x27;t yet exist). This requires <em>causal ordering</em> of
changes, which we implement by each change declaring its <em>dependencies</em>.</p><p>Every change by actor <em>X</em> with sequence number <em>n</em> (with <em>n</em> &gt; 1) implicitly
depends on <em>X</em>&#x27;s change with sequence number <em>n</em> â€“ 1. Moreover, assume that
in between <em>X</em> generating change number <em>n</em> â€“ 1 and change number <em>n</em>, <em>X</em>
received a change from actor <em>Y</em> with sequence number <em>m</em>. In that case, <em>X</em>&#x27;s
change <em>n</em> also declares an explicit dependency on <em>Y</em>&#x27;s change <em>m</em>.</p><p>When any Automerge instance wants to apply a change that depends on another
change, it ensures that the dependency is applied first. If it has not yet
received the dependency, the dependent change is buffered until the prerequisite
change arrives. This ordering and buffering process happens automatically, which
means that you can pass changes to <code>Automerge.applyChanges()</code> in any order, and
Automerge will take care of applying them in causal order.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="change-structure-and-operation-types">Change structure and operation types<a aria-hidden="true" class="hash-link" href="#change-structure-and-operation-types" title="Direct link to heading">â€‹</a></h2><p><strong>NB. This section describes the format used by the currently released version
of Automerge (on the <code>main</code> branch). A new format is in development on the
<code>performance</code> branch).</strong></p><p>Every change is a JSON object with five properties:</p><ul><li><code>actor</code>: The actor ID on which the change originated (a UUID).</li><li><code>seq</code>: The sequence number of the change, starting with 1 for a given actor
ID and proceeding as an incrementing sequence.</li><li><code>deps</code>: The change&#x27;s dependencies, represented as an object where keys are
actor IDs and values are the highest sequence number seen from that actor:
<code>{[actorId1]: seq1, [actorId2]: seq2, ...}</code>. The implicit dependency on
sequence number <code>seq â€“ 1</code> by the same <code>actor</code> need not be declared. Any
dependency that is also a transitive dependency of another change need not
be declared either.</li><li><code>message</code>: An optional human-readable &quot;commit message&quot; that describes the
change in a meaningful way. It is not interpreted by Automerge, only
stored for introspection, debugging, undo, and similar purposes.</li><li><code>ops</code>: An array of operations that are grouped into this change.</li></ul><p>Each operation acts on an object, which is identified by a UUID. There are four
types of object: <code>map</code> (represented in the document as a JavaScript object),
<code>list</code> (represented as a JavaScript array), <code>text</code> (represented as an instance
of <code>Automerge.Text</code>), and <code>table</code> (represented as an instance of
<code>Automerge.Table</code>). When processing operations, we mostly consider just <code>map</code>
and <code>list</code> as object types, because <code>table</code> behaves almost like <code>map</code>, and
<code>text</code> behaves almost like <code>list</code>. The root of an Automerge document has
a special UUID that consists only of zeroes, and its type is always <code>map</code>.</p><p>Note that <code>Automerge.Counter</code> and <code>Date</code> objects are not types of object for
Automerge purposes, but rather datatypes of values (see documentation of the
<code>set</code> operation).</p><p>Each operation in the <code>ops</code> array of a change is a JSON object. Automerge
currently uses the following types of operation:</p><ul><li><p><code>{ action: &#x27;makeMap&#x27;, obj: objectId }</code></p><p>The user created a new empty map object, and that object will henceforth be
identified by the UUID <code>obj</code>. The contents of the map, and its position within
the document, are defined by subsequent operations. For the root object, which
has a fixed UUID consisting of all zeros, a <code>makeMap</code> operation is not
required.</p></li><li><p><code>{ action: &#x27;makeList&#x27;, obj: objectId }</code></p><p>The user created a new empty list object, and that list will henceforth be
identified by the UUID <code>obj</code>.</p></li><li><p><code>{ action: &#x27;makeText&#x27;, obj: objectId }</code></p><p>The user created a new empty text sequence, and that sequence will henceforth
be identified by the UUI <code>obj</code>. (A text sequence provides better performance
for text editing compared with using a regular JavaScript array.)</p></li><li><p><code>{ action: &#x27;makeTable&#x27;, obj: objectId }</code></p><p>The user created a new empty table, and that table will henceforth be
identified by the UUID <code>obj</code>. The table does not enforce a schema; the columns
that exist in the table depend on the contents of each row. Rows are added in
subsequent operations.</p></li><li><p><code>{ action: &#x27;ins&#x27;, obj: listId, key: elemId, elem: uint }</code></p><p>The user inserted a new item into a list or text object. <code>obj</code> is the UUID of
the object being modified. <code>key</code> is the ID of an existing element after which
the new element should be inserted, or the string <code>&#x27;_head&#x27;</code> if the new element
should be inserted at the beginning of the list. <code>elem</code> is an integer that is
strictly greater than the <code>elem</code> value of any other element in this list at
the time of insertion.</p><p>The ID of the newly inserted list element is constructed by concatenating the
actor ID on which the operation originated, a colon character <code>&#x27;:&#x27;</code>, and the
elem value (as a decimal string). This ID is unique per list: although
different actors may generate insertions with the same elem value, the same
actor never reuses elems. This element ID is then used by subsequent <code>set</code> and
<code>link</code> operations to assign a value to the list element, by <code>del</code> operations
to delete the list element, and by <code>ins</code> operations to insert new list
elements after this one.</p><p>Note that the operation does not use list indexes, which are not safe under
concurrent use, but instead uses unique identifiers for list elements. Note
also that this operation does not specify what value should be inserted into
the list; it only creates a placeholder at a particular position. A subsequent
<code>set</code> or <code>link</code> operation is used to assign the actual value.</p><p>The elem value looks a bit similar to a sequence number in the vector clock,
but it is different due to the requirement that it must be greater than <em>any
other</em> elem in that list (regardless of originating actor). This fact is
required to ensure the list elements are ordered correctly. Technically, this
construction is known as a
<a href="https://en.wikipedia.org/wiki/Lamport_timestamps" target="_blank" rel="noopener noreferrer">Lamport timestamp</a>.</p></li><li><p><code>{ action: &#x27;set&#x27;, obj: objectId, key: key, value: value, datatype: datatype }</code></p><p>The user assigned a value to a key in a map, added a row to a table, or
assigned a value to an index in a list. <code>obj</code> is the UUID of the object being
modified. If the object is a map, <code>key</code> is the name of the field being
assigned. If the object is a list or text, <code>key</code> is the unique ID
of the list element to be updated, as created by a prior <code>ins</code> operation.
<code>value</code> is always a primitive value (string, number, boolean, or null); use a
<code>link</code> operation for assigning objects.</p><p>The <code>datatype</code> property is usually absent, in which case the property value
is just the primitive <code>value</code> as given. If the value of the <code>datatype</code> property
is <code>&#x27;counter&#x27;</code>, the value must be an integer, and it is turned into an
<code>Automerge.Counter</code> object in the document. If the <code>datatype</code> property is
<code>&#x27;timestamp&#x27;</code>, the value is interpreted as the number of milliseconds since
the 1970 Unix epoch, and turned into a JavaScript
<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date" target="_blank" rel="noopener noreferrer">Date</a>
object in the document.</p></li><li><p><code>{ action: &#x27;link&#x27;, obj: objectId, key: key, value: objectId }</code></p><p>The user took a previously created object (created with <code>makeMap</code>, <code>makeList</code>,
<code>makeText</code>, or <code>makeTable</code>), and made it a nested object within another
object. Put another way, this operation creates a reference or pointer from
one object to another. Multiple references to the same element are not allowed.
Moreover, reference cycles are not allowed; the code currently doesn&#x27;t check
for them, so if you create a cycle, you&#x27;ll get infinite loops.</p><p><code>obj</code> is the UUID of the object being modified (i.e. the parent object in the
nesting). If the object is a map, <code>key</code> is the name of the property in the
parent object being updated. If the object is a table, <code>key</code> is the primary
key of the row (= the object ID of the row). If the object is a list or text,
<code>key</code> is the ID of the list element, as created by a prior <code>ins</code> operation.
<code>value</code> is the UUID of the object being referenced (i.e. the child object).</p></li><li><p><code>{ action: &#x27;del&#x27;, obj: objectId, key: key }</code></p><p>The user deleted a key from a map, a row from a table, or an element from a
list or text object. <code>obj</code> is the UUID of the object being modified. <code>key</code>
is the key being removed from the map, the primary key of the row being
removed from the table, or the ID of the list/text element being removed,
as appropriate.</p></li><li><p><code>{ action: &#x27;inc&#x27;, obj: objectId, key: key, value: number }</code></p><p>The user incremented or decremented the value of an <code>Automerge.Counter</code>.
<code>obj</code> is the UUID of the parent object being modified, and <code>key</code> is the name
of the property or the list element ID where the counter is located within
that object. <code>value</code> is the amount by which the counter is incremented, with
a negative value representing a decrement.</p></li></ul><p>For example, the following code:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI js"><pre tabindex="0" class="prism-code language-js codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token maybe-class-name">Automerge</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">change</span><span class="token punctuation" style="color:#393A34">(</span><span class="token maybe-class-name">Automerge</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Create document&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token parameter">doc</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> doc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">cards</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">title</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;hello world&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>generates the following JSON object describing the change:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI js"><pre tabindex="0" class="prism-code language-js codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">actor</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;be3a9238-66c1-4215-9694-8688f1162cea&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// actorId where this change originated</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">seq</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">                                               </span><span class="token comment" style="color:#999988;font-style:italic">// sequence number 1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">deps</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">                                             </span><span class="token comment" style="color:#999988;font-style:italic">// no dependencies on other changes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">message</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Create document&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">                           </span><span class="token comment" style="color:#999988;font-style:italic">// human-readable description</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">ops</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">action</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;makeList&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">                              </span><span class="token comment" style="color:#999988;font-style:italic">// Make a list object to hold the cards</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token literal-property property" style="color:#36acaa">obj</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;3a64c13f-c270-4af4-a733-abaadc5e7c46&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic">// New UUID for the list</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">action</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;ins&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">                                   </span><span class="token comment" style="color:#999988;font-style:italic">// Insert a new element into the list we created</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token literal-property property" style="color:#36acaa">obj</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;3a64c13f-c270-4af4-a733-abaadc5e7c46&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic">// UUID of the list object</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token literal-property property" style="color:#36acaa">key</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;_head&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">                                    </span><span class="token comment" style="color:#999988;font-style:italic">// Insert at the beginning of the list</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token literal-property property" style="color:#36acaa">elem</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">action</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;makeMap&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">                               </span><span class="token comment" style="color:#999988;font-style:italic">// Make a map object to reprsent a card</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token literal-property property" style="color:#36acaa">obj</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;4f1cd0ee-3855-4b56-9b8d-85f88cd614e3&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic">// New UUID for the card</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">action</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;set&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">                                   </span><span class="token comment" style="color:#999988;font-style:italic">// Set the title of the card</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token literal-property property" style="color:#36acaa">obj</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;4f1cd0ee-3855-4b56-9b8d-85f88cd614e3&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic">// UUID of the card object</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token literal-property property" style="color:#36acaa">key</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;title&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token literal-property property" style="color:#36acaa">value</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;hello world&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">action</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;link&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">                                  </span><span class="token comment" style="color:#999988;font-style:italic">// Make the card the first element of the list</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token literal-property property" style="color:#36acaa">obj</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;3a64c13f-c270-4af4-a733-abaadc5e7c46&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic">// UUID of the list object</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token literal-property property" style="color:#36acaa">key</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;be3a9238-66c1-4215-9694-8688f1162cea:1&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic">// Assign to the list element with elem:1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token literal-property property" style="color:#36acaa">value</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;4f1cd0ee-3855-4b56-9b8d-85f88cd614e3&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// UUID of the card object</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">action</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;link&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">                                  </span><span class="token comment" style="color:#999988;font-style:italic">// Place the list of cards in the root object</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token literal-property property" style="color:#36acaa">obj</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;00000000-0000-0000-0000-000000000000&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic">// UUID of the root object (hard-coded)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token literal-property property" style="color:#36acaa">key</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;cards&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token literal-property property" style="color:#36acaa">value</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;3a64c13f-c270-4af4-a733-abaadc5e7c46&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_y2LR" id="frontend-backend-protocol">Frontend-backend protocol<a aria-hidden="true" class="hash-link" href="#frontend-backend-protocol" title="Direct link to heading">â€‹</a></h2><p>Internally, most of Automerge is split into two major parts: a frontend and a
backend. The source code is organised into two directories with these names.
The idea behind this split is that the two parts can run on two separate
threads: the frontend runs as part of the user application on the render thread,
while the backend can run in a background thread, e.g. as a
<a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers" target="_blank" rel="noopener noreferrer">web worker</a>.
This allows the backend to perform computationally expensive tasks without
affecting the responsiveness of the user interface.</p><p>If you use the <code>Automerge.{init,load,change,...}</code> APIs, you don&#x27;t see the
frontend/backend distinction, and both just run on the same thread (the frontend
communicates with the backend by just calling its functions directly). If you
want to run them on separate threads, you need to use the <code>Automerge.Frontend.*</code>
and <code>Automerge.Backend.*</code> APIs instead, and you will have to wire up the
inter-thread communication yourself.</p><p>The communication between frontend and backend is by asynchronous
message-passing, and the messages consist only of regular JavaScript objects and
arrays (no instances of any other classes), so they can be serialized to JSON if
necessary. This design also opens up the possibility of frontend and backend
being implemented in different languages. The only requirement is that messages
between frontend and backend must be received in the order they were sent â€”
reordering is not allowed.</p><p>Changes that are made by the local user are first made to the frontend, and then
sent to the backend; the backend processes the change, and then sends a
confirmation back to the frontend. When changes arrive over the network from
remote users, they are first processed by the backend, and then sent to the
frontend to update its state.</p><p>Messages from the frontend to the backend are called <strong>change requests</strong> (as
they always represent a change made by the local user, via
<code>Automerge.{change,undo,redo}</code>). Messages from the backend to the frontend are
called <strong>patches</strong> (because they describe a modification that needs to be made
to the frontend state).</p><p><strong>NB. This section describes the frontend/backend communication protocol used by
the currently released version of Automerge (on the <code>main</code> branch). An updated
protocol has been implemented on the <code>performance</code> branch).</strong></p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="change-requests">Change requests<a aria-hidden="true" class="hash-link" href="#change-requests" title="Direct link to heading">â€‹</a></h3><p>Change requests (sent from frontend to backend) are generated by
<code>Frontend.from()</code>, <code>Frontend.change()</code>, <code>Frontend.emptyChange()</code>,
<code>Frontend.undo()</code>, or <code>Frontend.redo()</code>. Change requests look very similar to
changes: they have properties <code>actor</code>, <code>seq</code>, <code>deps</code>, <code>message</code>, and <code>ops</code> as
documented above. The difference is that there is one additional property
<code>requestType</code>, whose value must be either <code>&#x27;change&#x27;</code>, <code>&#x27;undo&#x27;</code>, or <code>&#x27;redo&#x27;</code>.</p><p>In the case of <code>&#x27;change&#x27;</code>, the other properties describe the change by the local
user that should be applied to the backend state. In the case of a <code>requestType</code>
of <code>&#x27;undo&#x27;</code> or <code>&#x27;redo&#x27;</code>, the change request does not contain any <code>ops</code> property
(but the other properties <code>actor</code>, <code>seq</code>, <code>deps</code>, and <code>message</code> are still
present). In this case, the list of ops is filled in by the backend (since the
backend maintains the undo/redo history).</p><p>A change request from the frontend is applied to the backend using
<code>Backend.applyLocalChange()</code>, and the backend responds with a patch describing
the change.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="patch-format">Patch format<a aria-hidden="true" class="hash-link" href="#patch-format" title="Direct link to heading">â€‹</a></h3><p>Three backend functions generate patches: <code>Backend.applyLocalChange()</code> takes
a change request from the frontend, applies it, and returns a patch confirming
the change; <code>Backend.applyChanges()</code> applies a set of existing changes (which
may be loaded from disk or received over the network) and returns a patch
describing the modifications made by those changes; and <code>Backend.getPatch()</code>
returns a patch that creates a new document from scratch, reflecting the current
backend state.</p><p>On the frontend, <code>Frontend.applyPatch()</code> applies a patch to an Automerge
document, returning an updated document.</p><p>A patch is a JSON object with the following properties:</p><ul><li><code>actor</code> and <code>seq</code>: If the patch is a response to a change request, these
properties are set to match the <code>actor</code> and <code>seq</code> in the change request.
Not set on patches generated by <code>applyChanges()</code> or <code>getPatch()</code>.</li><li><code>canUndo</code> and <code>canRedo</code>: Booleans that indicate whether, after applying this
patch, <code>undo()</code> and <code>redo()</code> should be enabled, respectively. Undo is enabled
if there is at least one local change that has not been undone, and redo is
enabled if there has been at least one undo since the last change.</li><li><code>clock</code> and <code>deps</code>: Objects in which the keys are actor IDs, and the values
are the highest sequence number that the backend has processed from that
actor. The difference between <code>clock</code> and <code>deps</code> is that <code>clock</code> contains all
actor IDs ever seen by the backend, while <code>deps</code> contains only direct
dependencies that cannot be reached transitively via one of the other
dependencies. The frontend should include <code>deps</code> in the next change request
it sends to the backend.</li><li><code>diffs</code>: An array of diffs, where each diff describes a modification to the
document. A diff is similar in purpose to an operation, but they differ in
the details, as shown below. (Terminology: a diff is contained in a patch,
while an operation is contained in a change.) Diffs must be applied to the
document in the order in which they appear in this array.</li></ul><p>A diff is a JSON object with the following properties:</p><ul><li><p><code>obj</code>: The UUID of the object being updated.</p></li><li><p><code>type</code>: The type of object being updated, which must be one of <code>&#x27;map&#x27;</code>,
<code>&#x27;table&#x27;</code>, <code>&#x27;list&#x27;</code>, or <code>&#x27;text&#x27;</code>.</p></li><li><p><code>path</code>: The path from the root of the document to the object being updated,
given as an array. The empty array refers to the root object. Otherwise, read
the array from left to right to traverse from the root object to <code>obj</code>. When
the object is a <code>map</code>, the path element is the name of the property to
navigate to. When the object is a <code>table</code>, the path element is the primary key
of the row. When the object is a <code>list</code> or <code>text</code>, the path element is the
integer index of the list element. The entire path may be <code>null</code> if the object
is not reachable from the document root.</p></li><li><p><code>action</code>: If the object is a <code>map</code> or <code>table</code>, the action is either
<code>&#x27;create&#x27;</code>, <code>&#x27;set&#x27;</code>, or <code>&#x27;remove&#x27;</code>. If the object is a <code>list</code> or <code>text</code>, the
action is one of <code>&#x27;create&#x27;</code>, <code>&#x27;insert&#x27;</code>, <code>&#x27;set&#x27;</code>, <code>&#x27;remove&#x27;</code>, or <code>&#x27;maxElem&#x27;</code>.
The action types are explained below.</p></li><li><p><code>key</code>: Used when the object is a <code>map</code> or <code>table</code>, and when the action is
<code>set</code> or <code>remove</code>. Indicates the name of the property (in the case of a <code>map</code>)
or the primary key of the row (in the case of a <code>table</code>) that should be
updated or removed.</p></li><li><p><code>index</code>: Used when the object is a <code>list</code> or <code>text</code>, and when the action is
one of <code>insert</code>, <code>set</code>, or <code>remove</code>. Indicates the integer list index where
a new element should be inserted, or where the value should be updated, or
that should be removed, respectively.</p></li><li><p><code>elemId</code>: Used when the object is a <code>list</code> or <code>text</code>, and when the action is
<code>insert</code>. This property contains the element ID of the newly inserted element,
as a string of the form <code>&#x27;actorId:integer&#x27;</code>.</p></li><li><p><code>value</code> or <code>link</code>: Used when the action is <code>set</code> or <code>insert</code>. Which property
is used depends on whether the value assigned or inserted in this action is
a primitive value (number, string, boolean, or null, in which case the <code>value</code>
property is used), or another object (in which case the <code>link</code> property
contains the object ID of the object assigned in this action).</p><p>The <code>value</code> property is also used when the action is <code>maxElem</code>. In this case,
the <code>value</code> property contains the highest <code>elem</code> integer that has appeared in
any <code>ins</code> operation (see documentation of the <code>ins</code> operation). This action
ensures that the same element ID is not reused in certain edge cases.</p></li><li><p><code>datatype</code>: Used when the action is <code>set</code> or <code>insert</code>, and the <code>value</code>
property is set. The value of the <code>datatype</code> property is either <code>&#x27;timestamp&#x27;</code>,
<code>&#x27;counter&#x27;</code>, or the property is absent. The meaning is as documented for the
<code>set</code> operation.</p></li><li><p><code>conflicts</code>: Used when the action is <code>set</code> or <code>insert</code>. If present, the value
is an array of objects, where each object represents a conflicting value that
was concurrently assigned to this property or list index. Each object in the
<code>conflicts</code> array has a property <code>actor</code> containing the ID of the actor that
assigned this value. In addition, the object has either a <code>link</code> property
(containing the object ID of the nested object that was assigned), or <code>value</code>
and <code>datatype</code> properties (containing the primitive value, and optionally the
datatype interpretation, that was assigned).</p></li></ul><h2 class="anchor anchorWithStickyNavbar_y2LR" id="applying-operations-to-the-backend">Applying operations to the backend<a aria-hidden="true" class="hash-link" href="#applying-operations-to-the-backend" title="Direct link to heading">â€‹</a></h2><p>The local state in the backend is comprised of a few different pieces:</p><ul><li><code>queue</code>: A list of pending changes that have not yet been applied because some
of their dependencies are missing.</li><li><code>history</code>: A list of all applied changes.</li></ul><p>The two pieces of state above represent the single source-of-truth for every
change that the system has observed. When saving and loading an Automerge CRDT,
only the <code>history</code> is used. The pieces described below contain cached information
that would otherwise have to be computed by iterating over the entire history.</p><ul><li><code>states</code>: A map keyed by actor IDs. The values are lists of the form
<code>[{change: change1, allDeps: allDeps1}, {change: ..., allDeps: ...}, ...]</code>,
where the n-th object in the list contains the change with sequence number n+1
by that actor, and <code>allDeps</code> is the full vector clock of dependencies (and
transitive dependencies) of that change.</li><li><code>byObject</code>: A map keyed by object ID, where each value is a map containing the
following keys:<ul><li><code>_init</code>: The operation that created this object (an object whose <code>action</code>
property is one of <code>makeMap</code>, <code>makeList</code>, <code>makeTable</code>, or <code>makeText</code>).</li><li><code>_keys</code>: A map where the keys are property names (in the case of a map
object), row primary keys (in the case of a table object), or element IDs
(in the case of a list or text object). The value for each key is a list of
operations that assign a value to this key. In the common case, there is
either no operation (indicating the absence of a value, e.g. a tombstone in
a list), or one operation (containing the current value of this property).
Multiple operations appear in this list if there were conflicting,
concurrent assignments to the same element.</li><li><code>_inbound</code>: The set of <code>link</code> operations whose value is this object ID; in
other words, the set of operations that establish a link between this
object and its parents. Normally an object may appear only once in the
tree, in which case it has exactly one parent, and this set contains
exactly one operation. The set is empty if the object is the root object,
or if it is removed from the tree.</li><li><code>_insertion</code>: Used in list and text objects only. A map whose keys are the
list element IDs, and the value for each key is the <code>ins</code> operation that
inserted the element with that ID.</li><li><code>_following</code>: Used in list and text objects only. A map whose keys are list
element IDs, or the string <code>&#x27;_head&#x27;</code>, and the value for each key is a list
of <code>ins</code> operations that reference that key in their <code>key</code> property. There
may be multiple such operations if there have been multiple insertions at
the same place in the list.</li><li><code>_elemIds</code>: Used in list and text objects only. An instance of the
<code>SkipList</code> class, containing the sequence of element IDs of visible elements
in the list (i.e. element IDs that have at least one associated value).
This skip list is used to efficiently translate between element IDs and
list indexes.</li></ul></li><li><code>clock</code>: A map where keys are actor IDs, and the value is the highest change
sequence number that we have applied from that actor. This represents the
current vector clock of the local state, containing all actor IDs ever seen.</li><li><code>deps</code>: A map of the same form as <code>clock</code>, but excluding transitive
dependencies â€” that is, containing only actorID/seqNo pairs that cannot be
reached through the indirect dependencies of another of the dependencies.</li><li><code>undoPos</code>: An integer, representing the current place in the undo stack. At
any point in time, the first <code>undoPos</code> elements of <code>undoStack</code> (i.e. indexes
0 to undoPosâ€“1) are undoable, and any indexes &gt;= undoPos in <code>undoStack</code> have
already been undone.</li><li><code>undoStack</code>: A list of list of operations. One element in the outer list is
pushed when a local change is performed through <code>applyLocalChange()</code>, and it
is set to the list of operations that need to be performed in order to undo
that change. Those operations are chosen such that they restore the prior
value(s) of any properties that are updated in the course of the local change.</li><li><code>redoStack</code>: A list of list of operations, similar to <code>undoStack</code>. Here, an
element is pushed to the outer list when an undo is performed, and it
contains the operations that we need to perform in order to undo the undo.</li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/automerge/automerge.github.io/edit/main/docs/how-it-works/backend.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_mt2f"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/cookbook/conflicts"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« <!-- -->Managing Conflicts</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/how-it-works/binary-format"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Binary Document Format<!-- --> Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#document-changes-and-operations" class="table-of-contents__link toc-highlight">Document, changes, and operations</a></li><li><a href="#actor-ids-vector-clocks-and-causality" class="table-of-contents__link toc-highlight">Actor IDs, vector clocks, and causality</a><ul><li><a href="#dependencies" class="table-of-contents__link toc-highlight">Dependencies</a></li></ul></li><li><a href="#change-structure-and-operation-types" class="table-of-contents__link toc-highlight">Change structure and operation types</a></li><li><a href="#frontend-backend-protocol" class="table-of-contents__link toc-highlight">Frontend-backend protocol</a><ul><li><a href="#change-requests" class="table-of-contents__link toc-highlight">Change requests</a></li><li><a href="#patch-format" class="table-of-contents__link toc-highlight">Patch format</a></li></ul></li><li><a href="#applying-operations-to-the-backend" class="table-of-contents__link toc-highlight">Applying operations to the backend</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/tutorial/introduction">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://join.slack.com/t/automerge/shared_invite/zt-e4p3760n-kKh7r3KRH1YwwNfiZM8ktw" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Slack community<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://inkandswitch.com" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Ink &amp; Switch<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/automerge/automerge" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 Automerge contributors. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.61857cbb.js"></script>
<script src="/assets/js/main.77a0dc06.js"></script>
</body>
</html>