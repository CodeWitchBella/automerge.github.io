<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.9">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Automerge CRDT RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Automerge CRDT Atom Feed"><title data-react-helmet="true">Runtime | Automerge CRDT</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://automerge.github.io/docs/how-it-works/runtime/"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Runtime | Automerge CRDT"><meta data-react-helmet="true" name="description" content="Operation Set"><meta data-react-helmet="true" property="og:description" content="Operation Set"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://automerge.github.io/docs/how-it-works/runtime/"><link data-react-helmet="true" rel="alternate" href="https://automerge.github.io/docs/how-it-works/runtime/" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://automerge.github.io/docs/how-it-works/runtime/" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.82e2244f.css">
<link rel="preload" href="/assets/js/runtime~main.bc1aba82.js" as="script">
<link rel="preload" href="/assets/js/main.ea04a768.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/automerge.png" alt="Automerge logo" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/img/automerge.png" alt="Automerge logo" class="themedImage_TMUO themedImage--dark_uzRr"></div><b class="navbar__title">Automerge</b></a><a class="navbar__item navbar__link navbar__link--active" href="/docs/hello/">Docs</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/automerge" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">🌜</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">🌞</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_lDyR"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_i9tI" type="button"></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/hello/">Welcome to Automerge</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/quickstart/">5-Minute Quick Start</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Tutorial</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Types</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Cookbook</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Internals</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/how-it-works/backend/">How Automerge works</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/how-it-works/binary-format/">Binary Document Format</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/how-it-works/runtime/">Runtime</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/how-it-works/storage/">Storage</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/how-it-works/sync/">Sync Protocol</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">API Docs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/api/">Other APIs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/glossary/">Glossary</a></li></ul></nav></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><div class="tocCollapsible_aw-L theme-doc-toc-mobile tocMobile_Tx6Y"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Runtime</h1></header><h2 class="anchor anchorWithStickyNavbar_y2LR" id="operation-set">Operation Set<a aria-hidden="true" class="hash-link" href="#operation-set" title="Direct link to heading">​</a></h2><p>Operation Set (OpSet), as the name suggested, is a set of operations. It is the runtime data structure of Automerge, that enables the creation, retrieval, updating, and deletion of objects. The merging of two documents is conceptually the union of two operation sets.</p><p>Everytime we update, delete or create an object, we insert an operation into the OpSet. And the retrieval of an object is actually the retrieval of an operation of the OpSet.</p><p>Every operation in the operation set is associated with a timestamp which indicates the causal order of the operation. We use <code>&lt;couter, actorID&gt;</code> as the timestamp, which is a Lamport clock.  In Automerge, the term &quot;actor&quot; is used instead of &quot;replica&quot;, but the two are essentially interchangeable. For the remainder of the document, we will refer to the timestamp of an operation as <code>OpId</code> (Operation ID).</p><p>Every Map or List object has an object ID, which is the OpId of the operation that creates the object. We use object ID to uniquelly identify an object in an Automerge document. The object ID of root is <code>&lt;0, 0&gt;</code>.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="operation-tree">Operation Tree<a aria-hidden="true" class="hash-link" href="#operation-tree" title="Direct link to heading">​</a></h2><p>With the growing number of operations in the OpSet, the time consumed for retrieval grows too. Therefore, we divided the OpSet into multiple Operation Tree (OpTree). An OpTree represents the set of operations associated with a specific object, so the number of OpTrees in an OpSet is equivalent to the number of objects in a document.</p><p>The reason why we use the term &quot;Tree&quot; is that we use a B-Tree to store it. But conceptually it is a table of operations.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="map">Map<a aria-hidden="true" class="hash-link" href="#map" title="Direct link to heading">​</a></h2><p>We can begin with a document that includes the Map objects but excludes the List objects.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="basic-idea">Basic Idea<a aria-hidden="true" class="hash-link" href="#basic-idea" title="Direct link to heading">​</a></h3><p>Every time we insert a property into a map object, we create an operation like this:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">Operation = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    OpId: lamport clock after increment,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ObjId: the objId of the map we&#x27;re manipulating,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Prop: the property name,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    action: &quot;set {someValue}&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>For example, if we do <code>root.key = A</code>，then we need to insert an operation like this:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    OpId: &lt;1, 0&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ObjId: &lt;0, 0&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Prop: &quot;key&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    action: &quot;set A&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>When we query a property of a Map object, we simply retrieve the operation manipulating the Map object with highest OpId. That is to say, if we have two operations:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">[</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        OpId: &lt;1, 0&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ObjId: &lt;0, 0&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Prop: &quot;key&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        action: &quot;set A&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        OpId: &lt;2, 0&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ObjId: &lt;0, 0&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Prop: &quot;key&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        action: &quot;set B&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>In this case, <code>root.get(&quot;key&quot;)</code> will return the operation <code>&lt;2, 0&gt;</code>, and then we can know the value of root.key is <code>B</code>.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="optree-of-map-object">OpTree of Map Object<a aria-hidden="true" class="hash-link" href="#optree-of-map-object" title="Direct link to heading">​</a></h3><p>To organize the operations, we use a table, which is OpTree to store the operations associated with a particular object. And the operations in a Map object&#x27;s OpTree are sorted by two columns:</p><ol><li>Prop: Operations with the same property are grouped together.</li><li>OpId: If two operations have the same <code>prop</code>, the operation with the lower <code>OpId</code> is placed before the other.</li></ol><blockquote><p>Since an OpTree is sorted by keys, we can use binary search to locate an operation with a particular key, which we will explore in more detail shortly.</p></blockquote><p>Furthermore, there are two additional columns we have not mentioned before: successor and predecessor. In a map object, if operation A is to override another operation B, then we say operation A is a successor of operation B. We can now define an operation as &quot;invisible&quot; if it has a successor.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="example">Example<a aria-hidden="true" class="hash-link" href="#example" title="Direct link to heading">​</a></h3><p>Let‘s say we have a code snippet in the following:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI rust"><pre tabindex="0" class="prism-code language-rust codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">let mut doc = Automerge::new();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">let mut tx = doc.transaction();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tx.put(ROOT, &quot;name&quot;, &quot;Alice&quot;)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tx.put(ROOT, &quot;age&quot;, &quot;21&quot;)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tx.put(ROOT, &quot;age&quot;, &quot;23&quot;)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tx.put(ROOT, &quot;age&quot;, &quot;24&quot;)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tx.put(ROOT, &quot;name&quot;, &quot;Bob&quot;)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tx.commit();</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>It will result in an OpTree like this:</p><img src="/assets/images/runtime1-7aeb194ba145282f4f33c26bdbb37470.png" width="60%"><p>To query and delete an object in a OpTree, we could use the following code:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI rust"><pre tabindex="0" class="prism-code language-rust codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">let mut tx = doc.transaction();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">let name = tx.get(ROOT, &quot;name&quot;)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tx.delete(ROOT, &quot;age&quot;)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tx.commit();</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Let&#x27;s explain how get, put and delete works in pseudocode. </p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="get">get<a aria-hidden="true" class="hash-link" href="#get" title="Direct link to heading">​</a></h3><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI c"><pre tabindex="0" class="prism-code language-c codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">def </span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">table</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> prop</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    operations</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _ </span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">search</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">table</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> prop</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    last </span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> operations</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">opertaions</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">len </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> last</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">action</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def </span><span class="token function" style="color:#d73a49">search</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">table</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> prop</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    result </span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    last_index </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// &quot;index of the last operation in the result&quot; + 1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    start_idx </span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> index of the first row that matches `prop` </span><span class="token comment" style="color:#999988;font-style:italic">// binary search</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end_idx </span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> index of the last row of the `table`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i in </span><span class="token function" style="color:#d73a49">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">start_idx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> end_idx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> table</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">prop </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> prop</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> table</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">visible</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">table</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> end_idx </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Let&#x27;s consider an example of <code>get(root, &quot;name&quot;)</code>:</p><ol><li>Initially, we use binary search to locate the starting position of the row where the <code>prop</code> is &quot;name&quot;, which is the row with index 3 in the figure above. Thus:</li></ol><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI c"><pre tabindex="0" class="prism-code language-c codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">start_idx </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end_idx </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ol start="2"><li><p>We iterate through <code>table[3]</code> to <code>table[4]</code> and append <code>op 5@actor0</code> to the <code>result</code>. Eventually, the <code>search</code> function returns <code>([op 5@actor0], 5)</code>.</p></li><li><p>Finally, in the <code>get</code> function, we return the <code>action.value</code> of <code>op 5@actor0</code>, and as a result, we obtain the value of <code>root.name</code>, which is &quot;Bob&quot;.</p></li></ol><h3 class="anchor anchorWithStickyNavbar_y2LR" id="put">put<a aria-hidden="true" class="hash-link" href="#put" title="Direct link to heading">​</a></h3><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI c"><pre tabindex="0" class="prism-code language-c codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">def </span><span class="token function" style="color:#d73a49">put</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">table</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> prop</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    operations</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> last_idx </span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">search</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">table</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> prop</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pred </span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> operation in operations</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pred</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">operation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">op</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local_op </span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        op</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">lamport_clock_inc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        obj</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> table</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">objId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        prop</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        action</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;set {value}&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pred</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        succ</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">add_succ</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">local_op</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pred</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> local_op</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">op</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">insert_op</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">local_op</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> last_idx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Let&#x27;s consider an example of <code>put(root, &quot;name&quot;, &quot;Carol&quot;)</code>:</p><ol><li>Initially, we use the <code>search</code> function to search for the predecessor and index, and it returns <code>([op 5@actor0], 5)</code>.</li><li>Next, a successor is added for <code>op 5@actor0</code>, which is <code>6@actor0</code>.</li><li>Finally, <code>op 6@actor0</code> is inserted at index 5 of the <code>table</code>.</li></ol><img src="/assets/images/runtime2-b4c475a7cb33bb8d760dc22c6ee81bd5.png" width="60%"><h3 class="anchor anchorWithStickyNavbar_y2LR" id="delete">delete<a aria-hidden="true" class="hash-link" href="#delete" title="Direct link to heading">​</a></h3><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI c"><pre tabindex="0" class="prism-code language-c codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">def </span><span class="token function" style="color:#d73a49">delete</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">table</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> prop</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    operations</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _ </span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">search</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">table</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> prop</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pred </span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> operation in operations</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pred</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">operation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">op</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    new_clock </span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">lamport_clock_inc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">add_succ</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pred</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> new_clock</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Let&#x27;s consider an example of <code>delete(root, &quot;age&quot;)</code>:</p><ol><li>We use the <code>search</code> function to find all currently visible operations where <code>prop</code> is <code>age</code>, and it returns <code>([4@actor0], 3)</code>.</li><li>We update the successor of <code>4@actor0</code> to the newly generated <code>OpId</code>.</li></ol><img src="/assets/images/runtime3-3719bf773a2b7db35f8b35daf5242325.png" width="60%"><p>At this point, when we execute <code>get(root, &quot;age&quot;)</code>, all operations where <code>prop = age</code> are invisible, so an empty result will be returned, and as a result, <code>age</code> is deleted.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="put_object">put_object<a aria-hidden="true" class="hash-link" href="#put_object" title="Direct link to heading">​</a></h3><p>In order to create a nested map, we also need to support the <code>put_object</code> operation.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI c"><pre tabindex="0" class="prism-code language-c codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">def </span><span class="token function" style="color:#d73a49">put_object</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">table</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> prop</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> obj_type</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    operations</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> last_idx </span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">search</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">table</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> prop</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pred </span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> operation in operations</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pred</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">operation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">op</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    new_obj_id </span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">lamport_clock_inc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local_op </span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        op</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> new_obj_id</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        obj</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> table</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">objId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        prop</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        action</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;make {obj_type}&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pred</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        succ</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">add_succ</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">local_op</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pred</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> local_op</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">op</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">insert_op</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">local_op</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> last_idx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> new_obj_id</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>For example, consider the following code snippet:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI c"><pre tabindex="0" class="prism-code language-c codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">contact </span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">put_object</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">root</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;contact&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Map</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">put</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">contact</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;email&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;alice@example.com&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ol><li>Call the <code>search</code> function, which returns <code>([], 3)</code> since no contacts exist at the moment.</li><li>Generate a <code>make map</code> operation and add it to index 3 of the table.</li><li>Function <code>put_object</code> returns the OpId <code>6@actor0</code>, which is the object id of the newly created map.</li><li>Using object id <code>6@actor0</code>, we can access the OpTree of <code>contact</code> and insert the <code>put, email, set &quot;alice@example.com&quot;</code> operation into it.</li></ol><img src="/assets/images/runtime4-a27bb5b9517037fee5693d01ebb2bb15.png" width="100%"><h3 class="anchor anchorWithStickyNavbar_y2LR" id="merge-two-documents">Merge two documents<a aria-hidden="true" class="hash-link" href="#merge-two-documents" title="Direct link to heading">​</a></h3><p>Merging two documents is equivalent to merging the operations of the two documents and updating the successors if necessary.</p><p>Considering the following code:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI rust"><pre tabindex="0" class="prism-code language-rust codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">let mut doc1 = Automerge::new();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">let mut tx = doc1.transaction();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tx.put(ROOT, &quot;name&quot;, &quot;Alice&quot;).unwrap();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tx.put(ROOT, &quot;age&quot;, &quot;21&quot;).unwrap();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tx.put(ROOT, &quot;age&quot;, &quot;22&quot;).unwrap();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tx.commit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">let mut doc2 = doc1.fork();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">let mut tx = doc1.transaction();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tx.put(ROOT, &quot;age&quot;, &quot;100&quot;).unwrap();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tx.commit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">let mut tx = doc2.transaction();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tx.put(ROOT, &quot;age&quot;, &quot;99&quot;).unwrap();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tx.commit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">doc1.merge(&amp;mut doc2)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">let mut tx = doc1.transaction();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">let res = tx.get(ROOT, &quot;age&quot;)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">println!(&quot;{:?}&quot;, res); // print 99</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tx.commit();</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Before merging, <code>doc1</code> might look like this:</p><img src="/assets/images/runtime5-0ddcf636262f667e90905740f4468711.png" width="60%"><p><code>doc2</code> might look like this:</p><img src="/assets/images/runtime6-52f28bad161c08226caec1b1967f7e84.png" width="60%"><p>After merging, the resulting document might look like this:</p><img src="/assets/images/runtime7-141d0aebb1afdfed94e22007730ff4cf.png" width="60%"><p>In this case, we merge two documents by adding <code>4@actor1</code> from <code>doc2</code> to <code>doc1</code>, which is missing from <code>doc1</code>. Then, since the predecessor of <code>4@actor1</code> is <code>3@actor0</code>, we need to add <code>4@actor1</code> to the successors group of <code>3@actor0</code>.</p><p>At this point, if you call <code>get(&quot;age&quot;)</code>, the search function will return two operations, <code>4@actor1</code> and <code>4@actor0</code>. Since the <code>get</code> function takes the last operation as the result, it returns <code>4@actor1</code>, which prints out 99 as the final result.</p><p>Furthermore, we have a function called <code>get_all</code>, which we can describe as follows:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI c"><pre tabindex="0" class="prism-code language-c codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">def </span><span class="token function" style="color:#d73a49">get_all</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">table</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> prop</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    operations</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _ </span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">search</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">table</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> prop</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    res </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> op in operations</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        res</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">op</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">action</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> res</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>In this example, calling <code>get_all(age)</code> will retrieve both <code>99</code> and <code>100</code>. It behaves as a multi-value register.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="list">List<a aria-hidden="true" class="hash-link" href="#list" title="Direct link to heading">​</a></h2><p>Now we will add the List object to our document. Before we explain how to generate list operations, you need to understand what a Replicated Growable Array is <a href="#refer-anchor-1"><sup>1</sup></a>.</p><p>We need to flatten the RGA tree into a table, just like what we did in Map. This is achieved by performing a Depth First Search (DFS) on the RGA tree. For example, for the following code snippet:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI rust"><pre tabindex="0" class="prism-code language-rust codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">let mut doc1 = Automerge::new();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">let mut tx = doc1.transaction();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">let list = tx.put_object(ROOT, &quot;list&quot;, ObjType::List)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tx.insert(&amp;list, 0, &quot;a&quot;)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tx.insert(&amp;list, 1, &quot;u&quot;)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tx.insert(&amp;list, 2, &quot;o&quot;)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tx.insert(&amp;list, 2, &quot;t&quot;)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tx.put(&amp;list, 0, &quot;A&quot;)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tx.commit();</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>We can build the RGA tree like this:</p><img src="/assets/images/runtime8-1a7914bdecbd4c9cf94896bb85dfbd91.png" width="30%"><p>We use DFS to traverse all nodes of the RGA tree and obtain the following table:</p><img src="/assets/images/runtime9-1cfba6c90d75ec7502c197c611fd59b1.png" width="60%"><p>However, the RGA tree is only a conceptual model, and we do not actually maintain a tree in memory. Next, we will describe in pseudocode how to perform get, delete, put, and insert on this table.</p><p><strong>Note: the definition of &quot;index&quot; can be confusing when used to refer to both the index of a table and the index of a list interchangeably. To prevent confusion, we will use the term &quot;row number&quot; to indicate the index of a table, while reserving the term &quot;index&quot; specifically for the index of a list.</strong></p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="get-1">get<a aria-hidden="true" class="hash-link" href="#get-1" title="Direct link to heading">​</a></h3><p>Before diving into the <code>get</code> function, it&#x27;s important to note that in the actual implementation of Automerge, tables are implemented using B-trees. This allows for faster query processing. Specifically, we can maintain a variable  <code>visible</code>  in each node that indicates how many visible elements are in the subtree rooted at that node. If we determine that the element we are looking for is definitely not in the current subtree, we can skip the current subtree entirely.</p><p>However, for the sake of simplicity in describing the algorithm, we will assume that no subtrees are skipped. If you are interested in adapating the algorithms to B-Tree, you can delve into the source code for a more detailed understanding.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI c"><pre tabindex="0" class="prism-code language-c codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">def </span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">table</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> index</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    operations</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _ </span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">nth</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">table</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> index</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    last </span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> operations</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">operations</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">len </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> last</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">action</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def </span><span class="token function" style="color:#d73a49">nth</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">table</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> index</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// last element we&#x27;ve ever seen</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    last_seen </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// number of elements in array we&#x27;ve ever seen </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    seen </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// current position</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pos </span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// result operations</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    res </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> operation in table</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// If the operation is &quot;insert&quot;, we may have a new element traversed (although it&#x27;s also possible that it&#x27;s not an element due to a preceding &quot;delete&quot; operation), and in that case, we need to clear the &quot;last_seen&quot; variable.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> operation is insert</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// If we&#x27;ve already seen enough elements, we should return the result</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> seen </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> index</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> res</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pos</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            last_seen </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// it could be a visible insert operation, or a visible put operation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> operation is visible </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> last_seen is null</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            seen </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            last_seen </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> operation</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// if `seen` is greater than `index`, the current operation is what we&#x27;re searching for</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> operation is visible </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> seen </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> index</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            res</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">operation</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pos</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> res</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pos</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Considering <code>get(list, 2)</code> as an example:</p><ol><li>Start iterating from the beginning and when we reach index 4, <code>seen</code> is equal to 3. So we add <code>operation 5@actor0</code> to the <code>res</code> list.</li><li>Return the result, which is <code>([5@actor0], 4)</code>.</li><li>By reading the value of <code>operation 5@actor0</code>, we get the final result <code>t</code>.</li></ol><h3 class="anchor anchorWithStickyNavbar_y2LR" id="delete-1">delete<a aria-hidden="true" class="hash-link" href="#delete-1" title="Direct link to heading">​</a></h3><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI c"><pre tabindex="0" class="prism-code language-c codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">def </span><span class="token function" style="color:#d73a49">delete</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">table</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> index</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    operations</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _ </span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">nth</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">table</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> index</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pred </span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> operation in operations</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pred</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">operation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">op</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">add_succ</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pred</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">lamport_clock_inc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Considering <code>delete(list, 3)</code> as an example:</p><ol><li>By calling the <code>nth</code> function, we obtain <code>([5@actor0], 4)</code>.</li><li>We updated the successor of <code>5@actor0</code> to the newly generated OpId <code>7@actor0</code>.</li></ol><img src="/assets/images/runtime10-a4a0b9fbaf7c56fec9a8cec5e82ac2ab.png" width="60%"><h3 class="anchor anchorWithStickyNavbar_y2LR" id="put-1">put<a aria-hidden="true" class="hash-link" href="#put-1" title="Direct link to heading">​</a></h3><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI c"><pre tabindex="0" class="prism-code language-c codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">def </span><span class="token function" style="color:#d73a49">put</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">table</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> index</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    operations</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pos </span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">nth</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">table</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> index</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    first </span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> operations</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> first is insert</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        prop </span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> first</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">op</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        prop </span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> first</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">prop</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pred </span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> operation in operations</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pred</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">operation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">op</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local_op </span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        op</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">lamport_clock_inc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        obj</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> table</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">objId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        prop</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        action</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;set {value}&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        succ</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> null</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pred</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        insert</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">add_succ</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pred</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> local_op</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">op</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">insert_op</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">local_op</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pos</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Considering <code>put(2, &quot;T&quot;)</code> as an example:</p><ol><li>By calling the <code>nth</code> function, we obtain <code>([5@actor0], 4)</code>.</li><li>Add successor for <code>op 5@actor0</code>, which is <code>7@actor0</code>.</li><li>Finally, <code>op 7@actor0</code> is inserted at row number 4 of the table.</li></ol><img src="/assets/images/runtime11-38a176f09354bbd5244b8c0a88cb164f.png" width="60%"><h3 class="anchor anchorWithStickyNavbar_y2LR" id="insert">insert<a aria-hidden="true" class="hash-link" href="#insert" title="Direct link to heading">​</a></h3><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI c"><pre tabindex="0" class="prism-code language-c codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">def </span><span class="token function" style="color:#d73a49">insert</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">table</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> index</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    insert_row_number</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> insert_prop </span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">insert_nth</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">table</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> index</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local_op </span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        op</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">lamport_clock_inc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        obj</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> table</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">objId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        prop</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> insert_prop</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        action</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;set {value}&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        succ</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> null</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pred</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> null</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">insert_op</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">local_op</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> insert_row_number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def </span><span class="token function" style="color:#d73a49">insert_nth</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">table</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> index</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// row number to be inserted at</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    insert_row_number </span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// prop of the operation to be inserted</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    insert_prop </span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// last element we&#x27;ve ever seen</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    last_seen </span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// number of elements we&#x27;ve ever seen </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    seen </span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// current position</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pos </span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> operation in table</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// If the operation is &quot;insert&quot;, we may have a new element traversed (although it&#x27;s also possible that it&#x27;s not an element due to a preceding &quot;delete&quot; operation), and in that case, we need to clear the &quot;last_seen&quot; variable.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> operation is insert</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// If we&#x27;ve already seen enough elements, the current position is the position to be inserted at</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> insert_row_number </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> seen </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> index</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// greater than or equal</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                insert_row_number </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pos</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            last_seen </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// it could be a visible insert operation, or a visible put operation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// update seen, last_seen and insert_prop </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> operation is visible </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> last_seen is null</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// if we&#x27;ve already seen enough elements, return the insert index and prop</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> seen </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> index</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> insert_row_number</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> insert_prop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            seen </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            last_seen </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> operation</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> operation is insert</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                insert_prop </span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> operation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">op</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">else</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                insert_prop </span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> operation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">prop</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pos</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// if index exceeds the table</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    insert_row_number </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> last row number of the table plus </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    insert_prop </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> last insert operation of the table</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> insert_row_number</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> insert_prop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Considering <code>insert(3, &quot;a&quot;)</code> as an example:</p><ol><li>When iterating to index 3, update the <code>insert_prop</code> as <code>5@actor0</code>.</li><li>When iterating to index 4, update the <code>insert_row_number</code> as 4.</li><li>Construct an insert operation and insert it at row number 4.</li></ol><img src="/assets/images/runtime12-36c01b6edc269b9bae862834a56acf7c.png" width="60%"><h3 class="anchor anchorWithStickyNavbar_y2LR" id="merge-two-documents-1">Merge two documents<a aria-hidden="true" class="hash-link" href="#merge-two-documents-1" title="Direct link to heading">​</a></h3><p>Like in maps, merging two documents is conceptually taking the union of two OpSets. Let&#x27;s consider the following code snippet:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI rust"><pre tabindex="0" class="prism-code language-rust codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">let mut doc1 = Automerge::new();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">let mut tx = doc1.transaction();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// auto</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">let list = tx.put_object(ROOT, &quot;list&quot;, ObjType::List)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tx.insert(&amp;list, 0, &quot;a&quot;)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tx.insert(&amp;list, 1, &quot;u&quot;)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tx.insert(&amp;list, 2, &quot;o&quot;)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tx.insert(&amp;list, 2, &quot;t&quot;)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tx.put(&amp;list, 0, &quot;A&quot;)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tx.commit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// matic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">let mut doc2 = doc1.fork();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">let mut tx = doc2.transaction();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tx.insert(&amp;list, 4, &quot;m&quot;)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tx.insert(&amp;list, 5, &quot;a&quot;)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tx.insert(&amp;list, 6, &quot;t&quot;)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tx.insert(&amp;list, 7, &quot;i&quot;)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tx.insert(&amp;list, 8, &quot;c&quot;)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tx.commit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// merge</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">let mut tx = doc1.transaction();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tx.insert(&amp;list, 4, &quot;m&quot;)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tx.insert(&amp;list, 5, &quot;e&quot;)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tx.insert(&amp;list, 6, &quot;r&quot;)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tx.insert(&amp;list, 7, &quot;g&quot;)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tx.insert(&amp;list, 8, &quot;e&quot;)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tx.commit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// automaticmerge</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">doc1.merge(&amp;mut doc2)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">for (i, val1, id) in doc1.list_range(&amp;list, ..) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let val2 = doc1.get(&amp;list, i)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    println!(&quot;{:?}&quot;, val2);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>doc1</code> before merging:</p><img src="/assets/images/runtime13-5323782f735c18e7167f6852961b92e3.png" width="60%"><p><code>doc2</code> before merging:</p><img src="/assets/images/runtime14-6125040d247c128740471a5b6b95705a.png" width="60%"><p>After merging:</p><img src="/assets/images/runtime15-cfe41165cb124759d4456da414d1815c.png" width="60%"><h2 class="anchor anchorWithStickyNavbar_y2LR" id="reference">Reference<a aria-hidden="true" class="hash-link" href="#reference" title="Direct link to heading">​</a></h2><div id="refer-anchor-1"></div><p>[1]<!-- --> H.-G. Roh, M. Jeon, J.-S. Kim, and J. Lee, “Replicated abstract data types: Building Blocks for Collaborative Applications,” <em>Journal of Parallel and Distributed Computing</em>, vol. 71, no. 3, pp. 354–368, 2011. doi:10.1016/j.jpdc.2010.12.006</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/automerge/automerge.github.io/edit/main/docs/how-it-works/runtime.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_mt2f"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/how-it-works/binary-format/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« <!-- -->Binary Document Format</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/how-it-works/storage/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Storage<!-- --> »</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#operation-set" class="table-of-contents__link toc-highlight">Operation Set</a></li><li><a href="#operation-tree" class="table-of-contents__link toc-highlight">Operation Tree</a></li><li><a href="#map" class="table-of-contents__link toc-highlight">Map</a><ul><li><a href="#basic-idea" class="table-of-contents__link toc-highlight">Basic Idea</a></li><li><a href="#optree-of-map-object" class="table-of-contents__link toc-highlight">OpTree of Map Object</a></li><li><a href="#example" class="table-of-contents__link toc-highlight">Example</a></li><li><a href="#get" class="table-of-contents__link toc-highlight">get</a></li><li><a href="#put" class="table-of-contents__link toc-highlight">put</a></li><li><a href="#delete" class="table-of-contents__link toc-highlight">delete</a></li><li><a href="#put_object" class="table-of-contents__link toc-highlight">put_object</a></li><li><a href="#merge-two-documents" class="table-of-contents__link toc-highlight">Merge two documents</a></li></ul></li><li><a href="#list" class="table-of-contents__link toc-highlight">List</a><ul><li><a href="#get-1" class="table-of-contents__link toc-highlight">get</a></li><li><a href="#delete-1" class="table-of-contents__link toc-highlight">delete</a></li><li><a href="#put-1" class="table-of-contents__link toc-highlight">put</a></li><li><a href="#insert" class="table-of-contents__link toc-highlight">insert</a></li><li><a href="#merge-two-documents-1" class="table-of-contents__link toc-highlight">Merge two documents</a></li></ul></li><li><a href="#reference" class="table-of-contents__link toc-highlight">Reference</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/tutorial/introduction/">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://join.slack.com/t/automerge/shared_invite/zt-e4p3760n-kKh7r3KRH1YwwNfiZM8ktw" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Slack community<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://inkandswitch.com" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Ink &amp; Switch<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog/">Blog</a></li><li class="footer__item"><a href="https://github.com/automerge/automerge" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Automerge contributors. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.bc1aba82.js"></script>
<script src="/assets/js/main.ea04a768.js"></script>
</body>
</html>